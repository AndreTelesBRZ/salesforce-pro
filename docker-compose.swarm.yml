version: "3.8"
services:
  salesforce-app:
    image: ${IMAGE}
    # Porta não exposta: acesso somente via Traefik (reverso)
    environment:
      NODE_ENV: production
      DB_PATH: /data/database.sqlite
      SECRET_KEY: ${SECRET_KEY}
      MASTER_KEY: ${MASTER_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      DATABASE_URL: ${DATABASE_URL}
      VITE_BACKEND_URL: ${VITE_BACKEND_URL}
    volumes:
      - salesforce_data:/data
    networks:
      - salesforce_net
      # Conecta também na rede do Traefik para habilitar roteamento por host
      - traefik_net
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      update_config:
        order: start-first
        parallelism: 1
        delay: 5s
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=traefik_public"
        # Roteador HTTPS
        - "traefik.http.routers.salesforce.rule=Host(`vendas.edsondosparafusos.app.br`,`vendas.llfix.app.br`)"
        - "traefik.http.routers.salesforce.entrypoints=websecure"
        - "traefik.http.routers.salesforce.tls=true"
        - "traefik.http.routers.salesforce.tls.certresolver=letsencryptresolver"
        # Middlewares de produção (HSTS + compress) aplicados no router HTTPS
        - "traefik.http.routers.salesforce.middlewares=salesforce-sec-headers,salesforce-compress"
        - "traefik.http.middlewares.salesforce-compress.compress=true"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.forceSTSHeader=true"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.stsSeconds=15552000"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.stsPreload=true"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.salesforce-sec-headers.headers.browserXSSFilter=true"
        - "traefik.http.services.salesforce.loadbalancer.server.port=8080"
        # Roteador HTTP com redirecionamento para HTTPS
        - "traefik.http.routers.salesforce-http.rule=Host(`vendas.edsondosparafusos.app.br`,`vendas.llfix.app.br`)"
        - "traefik.http.routers.salesforce-http.entrypoints=web"
        - "traefik.http.routers.salesforce-http.middlewares=salesforce-redirect-https"
        - "traefik.http.middlewares.salesforce-redirect-https.redirectscheme.scheme=https"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  salesforce_net:
    driver: overlay
  # Rede externa já criada pelo stack do Traefik
  traefik_net:
    external: true
    name: traefik_public

volumes:
  salesforce_data:
